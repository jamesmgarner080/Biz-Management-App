{'role': 'assistant', 'content': '<function_calls>\n<str-replace file_path="frontend/js/app.js">\n<old_str>// User Management Functions\nfunction openUserModal(userId = null) {\n    const modal = document.getElementById(\'userModal\');\n    const modalTitle = document.getElementById(\'userModalTitle\');\n    const form = document.getElementById(\'userForm\');\n    const passwordGroup = document.getElementById(\'passwordGroup\');\n    \n    // Reset form\n    form.reset();\n    document.getElementById(\'userId\').value = \'\';\n    \n    if (userId) {\n        // Edit mode\n        modalTitle.textContent = \'Edit User\';\n        passwordGroup.style.display = \'none\';\n        document.getElementById(\'userPassword\').required = false;\n        \n        // Load user data\n        apiRequest(`/users/${userId}`).then(user => {\n            document.getElementById(\'userId\').value = user.id;\n            document.getElementById(\'userUsername\').value = user.username;\n            document.getElementById(\'userFullName\').value = user.full_name;\n            document.getElementById(\'userEmail\').value = user.email || \'\';\n            document.getElementById(\'userPhone\').value = user.phone || \'\';\n            document.getElementById(\'userRole\').value = user.role;\n        }).catch(error => {\n            console.error(\'Error loading user:\', error);\n            showToast(\'Failed to load user\', \'error\');\n        });\n    } else {\n        // Create mode\n        modalTitle.textContent = \'Create User\';\n        passwordGroup.style.display = \'block\';\n        document.getElementById(\'userPassword\').required = true;\n    }\n    \n    modal.classList.remove(\'hidden\');\n}</old_str>\n<new_str>// User Management Functions\nasync function openUserModal(userId = null) {\n    const modal = document.getElementById(\'userModal\');\n    const modalTitle = document.getElementById(\'userModalTitle\');\n    const form = document.getElementById(\'userForm\');\n    const passwordGroup = document.getElementById(\'passwordGroup\');\n    const customPermissionsGroup = document.getElementById(\'customPermissionsGroup\');\n    \n    // Reset form\n    form.reset();\n    document.getElementById(\'userId\').value = \'\';\n    \n    // Load available permissions for admin\n    if (currentUser.role === \'admin\') {\n        try {\n            const permissions = await apiRequest(\'/permissions/available\');\n            const checkboxContainer = document.getElementById(\'permissionCheckboxes\');\n            checkboxContainer.innerHTML = permissions.map(p => `\n                <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; cursor: pointer;">\n                    <input type="checkbox" name="permission" value="${p.permission}" class="permission-checkbox">\n                    <span>${getPermissionDisplayName(p.permission)}</span>\n                </label>\n            `).join(\'\');\n            customPermissionsGroup.style.display = \'block\';\n        } catch (error) {\n            console.error(\'Error loading permissions:\', error);\n        }\n    } else {\n        customPermissionsGroup.style.display = \'none\';\n    }\n    \n    if (userId) {\n        // Edit mode\n        modalTitle.textContent = \'Edit User\';\n        passwordGroup.style.display = \'none\';\n        document.getElementById(\'userPassword\').required = false;\n        \n        // Load user data\n        try {\n            const user = await apiRequest(`/users/${userId}`);\n            document.getElementById(\'userId\').value = user.id;\n            document.getElementById(\'userUsername\').value = user.username;\n            document.getElementById(\'userFullName\').value = user.full_name;\n            document.getElementById(\'userEmail\').value = user.email || \'\';\n            document.getElementById(\'userPhone\').value = user.phone || \'\';\n            document.getElementById(\'userRole\').value = user.role;\n            \n            // Load user\'s custom permissions\n            if (currentUser.role === \'admin\') {\n                const permData = await apiRequest(`/permissions/user/${userId}`);\n                const customPerms = permData.customPermissions.map(p => p.permission);\n                \n                // Check the boxes for custom permissions\n                document.querySelectorAll(\'.permission-checkbox\').forEach(checkbox => {\n                    checkbox.checked = customPerms.includes(checkbox.value);\n                });\n            }\n        } catch (error) {\n            console.error(\'Error loading user:\', error);\n            showToast(\'Failed to load user\', \'error\');\n        }\n    } else {\n        // Create mode\n        modalTitle.textContent = \'Create User\';\n        passwordGroup.style.display = \'block\';\n        document.getElementById(\'userPassword\').required = true;\n    }\n    \n    modal.classList.remove(\'hidden\');\n}</new_str>\n</str-replace>\n</function_calls>'}